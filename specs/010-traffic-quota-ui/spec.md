# Feature Specification: 流量配额管理与 UI 增强

**Feature Branch**: `010-traffic-quota-ui`
**Created**: 2026-01-14
**Status**: Draft
**Input**: User description: "npm启动的服务界面太简陋了，而且还有一些功能未开发，并且我还希望可以分配给不同链接指定流量额度，还可以查看流量额度"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 为用户分配流量配额 (Priority: P1)

作为服务管理员，我希望能够为每个用户/链接分配指定的流量额度，以便控制和管理用户的流量使用。

**Why this priority**: 流量配额管理是用户明确提出的核心需求，直接影响服务的商业价值和资源控制能力。

**Independent Test**: 可以通过创建用户并设置流量配额，然后验证配额是否正确保存和显示来独立测试。

**Acceptance Scenarios**:

1. **Given** 管理员在用户管理界面, **When** 创建新用户时, **Then** 可以设置该用户的流量配额（如 10GB、50GB、无限制等）
2. **Given** 已存在的用户, **When** 管理员编辑用户信息时, **Then** 可以修改该用户的流量配额
3. **Given** 用户流量配额设置完成, **When** 保存配置时, **Then** 系统持久化保存配额设置

---

### User Story 2 - 查看用户流量使用情况 (Priority: P1)

作为服务管理员，我希望能够查看每个用户的流量使用情况和剩余配额，以便监控服务使用状态。

**Why this priority**: 与配额分配同等重要，管理员需要实时了解流量使用情况才能有效管理服务。

**Independent Test**: 可以通过查看用户列表或用户详情，验证流量统计数据是否正确显示。

**Acceptance Scenarios**:

1. **Given** 管理员在用户列表界面, **When** 查看用户列表时, **Then** 每个用户显示已用流量、配额总量、剩余流量
2. **Given** 管理员选择某个用户, **When** 查看用户详情时, **Then** 显示详细的流量使用统计（上行/下行流量）
3. **Given** 用户流量接近或超过配额, **When** 管理员查看时, **Then** 系统以醒目方式提示（如颜色标记）

---

### User Story 3 - 改进的服务管理界面 (Priority: P2)

作为服务管理员，我希望有一个更美观、功能更完善的管理界面，以便更高效地管理 VPN 服务。

**Why this priority**: UI 改进提升用户体验，但不影响核心功能，因此优先级略低于流量管理功能。

**Independent Test**: 可以通过启动 CLI 工具，验证界面布局、信息展示和交互是否符合预期。

**Acceptance Scenarios**:

1. **Given** 管理员启动 CLI 工具, **When** 进入主界面时, **Then** 显示清晰的仪表盘，包含服务状态、用户统计、流量概览
2. **Given** 管理员在任意界面, **When** 进行操作时, **Then** 界面响应流畅，操作反馈及时
3. **Given** 管理员需要执行常用操作, **When** 浏览菜单时, **Then** 菜单结构清晰，常用功能易于访问

---

### User Story 4 - 流量配额预警通知 (Priority: P3)

作为服务管理员，我希望当用户流量接近配额限制时收到提醒，以便及时处理。

**Why this priority**: 预警功能是增强功能，在基础流量管理功能完成后再实现。

**Independent Test**: 可以通过模拟用户流量达到阈值，验证系统是否正确显示预警信息。

**Acceptance Scenarios**:

1. **Given** 用户流量达到配额的 80%, **When** 管理员查看用户列表时, **Then** 该用户显示黄色警告标记
2. **Given** 用户流量达到配额的 100%, **When** 管理员查看用户列表时, **Then** 该用户显示红色超额标记

---

### Edge Cases

- 当用户流量配额设置为 0 或负数时，系统应拒绝并提示有效范围
- 当用户流量配额设置为"无限制"时，系统应正确处理并显示
- 当 Xray 服务未运行时，流量统计数据应显示"服务未运行"而非错误
- 当流量统计数据不可用时（如首次安装），应显示"暂无数据"
- 当多个用户同时使用时，流量统计应准确反映各用户的实际使用量

## Requirements *(mandatory)*

### Functional Requirements

**流量配额管理**

- **FR-001**: 系统必须允许管理员为每个用户设置流量配额（支持 MB、GB、TB 单位）
- **FR-002**: 系统必须支持"无限制"流量配额选项（新用户默认为无限制）
- **FR-003**: 系统必须持久化保存用户的流量配额设置
- **FR-004**: 系统必须允许管理员随时修改用户的流量配额

**流量统计与显示**

- **FR-005**: 系统必须从 Xray 服务获取每个用户的流量使用数据（实时查询，每次打开/刷新界面时获取）
- **FR-006**: 系统必须显示每个用户的上行流量、下行流量、总流量
- **FR-007**: 系统必须计算并显示每个用户的剩余流量配额
- **FR-008**: 系统必须以人类可读格式显示流量数据（自动转换 KB/MB/GB/TB）

**界面增强**

- **FR-009**: 系统必须提供改进的仪表盘，显示服务状态、用户统计、流量概览
- **FR-010**: 系统必须在用户列表中显示流量使用进度条或百分比
- **FR-011**: 系统必须对流量接近配额（≥80%）的用户显示警告标记
- **FR-012**: 系统必须对流量超过配额（≥100%）的用户显示超额标记

**配额重置**

- **FR-013**: 系统必须支持手动重置用户的已用流量统计

**配额超限处理**

- **FR-014**: 系统必须在用户流量超过配额时自动禁用该用户的连接
- **FR-015**: 系统必须允许管理员手动重新启用被禁用的用户

### Key Entities

- **User（用户）**: 代表一个 VPN 用户，包含 UUID、邮箱标识、流量配额、已用流量等属性
- **TrafficQuota（流量配额）**: 代表用户的流量限制，包含配额值、单位、是否无限制等属性
- **TrafficUsage（流量使用）**: 代表用户的流量使用情况，包含上行流量、下行流量、统计时间等属性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员可以在 30 秒内完成为新用户设置流量配额的操作
- **SC-002**: 用户列表界面在 2 秒内加载完成并显示所有用户的流量信息
- **SC-003**: 流量统计数据与 Xray 实际记录的误差不超过 1%
- **SC-004**: 100% 的流量配额设置在服务重启后仍然保持有效
- **SC-005**: 界面清晰度提升，用户可以一眼识别哪些用户流量接近或超过配额

## Clarifications

### Session 2026-01-14

- Q: 用户流量超过配额后的处理策略？ → A: 自动禁用该用户的连接
- Q: 流量统计数据的刷新频率？ → A: 仅在用户打开/刷新界面时查询（实时查询）
- Q: 流量配额的默认值？ → A: 默认无限制（管理员需手动设置限制）

## Assumptions

- Xray 服务已正确配置并支持流量统计功能（通过 stats API）
- 管理员具有 root 或 sudo 权限来访问 Xray 配置和统计数据
- 流量统计基于 Xray 内置的统计功能，不需要额外的监控工具
- 流量配额数据存储在本地配置文件中，与 Xray 配置分离管理
- 流量重置周期由管理员手动触发，暂不支持自动周期重置
